import { useEffect, useState, type FormEvent } from "react";
import "../../styles/reset.css";
import "../../styles/menu.css";
import {
  useHocKyNienKhoa,
  useSetHocKyHienTai,
  useCreateBulkKyPhase,
  useGetHocKyHienHanh,
  usePhasesByHocKy,
  useUpdateDotGhiDanh,
} from "../../features/pdt/hooks";
import { HocKyNienKhoaShowSetup } from "./components/HocKyNienKhoaShowSetup";
import { PhaseHocKyNienKhoaSetup } from "./components/PhaseHocKyNienKhoaSetup";
import type { SetHocKyHienTaiRequest, PhaseItemDTO } from "../../features/pdt";
import { toDatetimeLocal } from "../../utils/dateHelpers";
import KhoaFilterForPhase from "./components/KhoaFilterForPhase";
import PhaseTimeEditor from "./components/PhaseTimeEditor";
import { useModalContext } from "../../hook/ModalContext";

type PhaseTime = { start: string; end: string };

type CurrentSemester = {
  ten_hoc_ky?: string | null;
  ten_nien_khoa?: string | null;
  ngay_bat_dau?: string | null;
  ngay_ket_thuc?: string | null;
};

const PHASE_NAMES: Record<string, string> = {
  de_xuat_phe_duyet: "Ti·ªÅn ghi danh",
  ghi_danh: "Ghi danh h·ªçc ph·∫ßn",
  sap_xep_tkb: "S·∫Øp x·∫øp th·ªùi kh√≥a bi·ªÉu",
  dang_ky_hoc_phan: "ƒêƒÉng k√Ω h·ªçc ph·∫ßn",
  binh_thuong: "B√¨nh th∆∞·ªùng",
};

const PHASE_ORDER: string[] = [
  "de_xuat_phe_duyet",
  "ghi_danh",
  "sap_xep_tkb",
  "dang_ky_hoc_phan",
  "binh_thuong",
];

// ‚úÖ MOVE HERE - Define helper function BEFORE component
const getEmptyPhaseTimes = (): Record<string, PhaseTime> => {
  return PHASE_ORDER.reduce((acc, phase) => {
    acc[phase] = { start: "", end: "" };
    return acc;
  }, {} as Record<string, PhaseTime>);
};

export default function ChuyenTrangThai() {
  const { openNotify } = useModalContext();

  // ‚úÖ D√πng hooks
  const { data: hocKyNienKhoas, loading: loadingHocKy } = useHocKyNienKhoa();
  const { setHocKyHienTai, loading: submittingHocKy } = useSetHocKyHienTai();
  const { createBulkKyPhase, loading: submittingPhase } =
    useCreateBulkKyPhase();
  const { updateDotGhiDanh, loading: ghiDanhLoading } = useUpdateDotGhiDanh();

  const { data: hocKyHienHanh, loading: loadingHienHanh } =
    useGetHocKyHienHanh();

  const [selectedHocKyId, setSelectedHocKyId] = useState<string>("");

  const { data: phasesData, loading: loadingPhases } =
    usePhasesByHocKy(selectedHocKyId);

  // State cho h·ªçc k·ª≥/ni√™n kh√≥a
  const [selectedNienKhoa, setSelectedNienKhoa] = useState<string>("");
  const [semesterStart, setSemesterStart] = useState<string>("");
  const [semesterEnd, setSemesterEnd] = useState<string>("");
  const [currentSemester, setCurrentSemester] = useState<CurrentSemester>({});
  const [semesterMessage, setSemesterMessage] = useState<string>("");

  // State cho phases - ‚úÖ Now getEmptyPhaseTimes is defined
  const [phaseTimes, setPhaseTimes] = useState<Record<string, PhaseTime>>(
    getEmptyPhaseTimes()
  );
  const [currentPhase, setCurrentPhase] = useState<string>("");
  const [message, setMessage] = useState<string>("");
  const [submitting, setSubmitting] = useState(false);

  // ‚úÖ Load h·ªçc k·ª≥ hi·ªán h√†nh khi mount
  useEffect(() => {
    if (!hocKyHienHanh) return;

    console.log(
      "üîç [ChuyenTrangThai] Auto-selecting from hocKyHienHanh:",
      hocKyHienHanh
    );

    setSelectedNienKhoa(hocKyHienHanh.nienKhoaId);
    setSelectedHocKyId(hocKyHienHanh.id);

    setSemesterStart(
      hocKyHienHanh.ngayBatDau ? hocKyHienHanh.ngayBatDau.split("T")[0] : ""
    );
    setSemesterEnd(
      hocKyHienHanh.ngayKetThuc ? hocKyHienHanh.ngayKetThuc.split("T")[0] : ""
    );

    setCurrentSemester({
      ten_hoc_ky: hocKyHienHanh.tenHocKy,
      ten_nien_khoa: hocKyHienHanh.tenNienKhoa,
      ngay_bat_dau: hocKyHienHanh.ngayBatDau
        ? hocKyHienHanh.ngayBatDau.split("T")[0]
        : "",
      ngay_ket_thuc: hocKyHienHanh.ngayKetThuc
        ? hocKyHienHanh.ngayKetThuc.split("T")[0]
        : "",
    });

    console.log(
      "‚úÖ [ChuyenTrangThai] Set selectedNienKhoa:",
      hocKyHienHanh.nienKhoaId
    );
    console.log("‚úÖ [ChuyenTrangThai] Set selectedHocKyId:", hocKyHienHanh.id);
  }, [hocKyHienHanh]);

  // ‚úÖ Load phases khi c√≥ data
  useEffect(() => {
    if (selectedHocKyId && !phasesData) {
      setPhaseTimes(getEmptyPhaseTimes());
      setCurrentPhase("");
      return;
    }

    if (!phasesData) return;

    const newPhaseTimes: Record<string, PhaseTime> = getEmptyPhaseTimes();

    phasesData.phases.forEach((phase) => {
      newPhaseTimes[phase.phase] = {
        start: toDatetimeLocal(phase.startAt),
        end: toDatetimeLocal(phase.endAt),
      };
    });

    setPhaseTimes(newPhaseTimes);

    const now = new Date();
    const currentPhaseItem = phasesData.phases.find((p) => {
      const start = new Date(p.startAt);
      const end = new Date(p.endAt);
      return p.isEnabled && now >= start && now <= end;
    });

    if (currentPhaseItem) {
      setCurrentPhase(currentPhaseItem.phase);
    } else {
      setCurrentPhase("");
    }
  }, [phasesData, selectedHocKyId]);

  // ‚úÖ Handler khi ch·ªçn h·ªçc k·ª≥ kh√°c
  const handleChangeHocKy = (hocKyId: string) => {
    setSelectedHocKyId(hocKyId);
    setPhaseTimes(getEmptyPhaseTimes());
    setCurrentPhase("");
    setMessage("");
  };

  // ‚úÖ Khi ƒë·ªïi ni√™n kh√≥a
  const handleChangeNienKhoa = (value: string) => {
    setSelectedNienKhoa(value);
    const nienKhoa = hocKyNienKhoas.find((nk) => nk.id === value);
    if (nienKhoa?.hocKy.length) {
      setSelectedHocKyId(nienKhoa.hocKy[0].id);
    } else {
      setSelectedHocKyId("");
    }
    setPhaseTimes(getEmptyPhaseTimes());
    setCurrentPhase("");
    setMessage("");
  };

  // ‚úÖ Submit h·ªçc k·ª≥/ni√™n kh√≥a
  const handleSubmitSemester = async (e: FormEvent) => {
    e.preventDefault();
    setSemesterMessage("");

    if (!selectedNienKhoa || !selectedHocKyId) {
      setSemesterMessage("‚ùå Vui l√≤ng ch·ªçn ƒë·∫ßy ƒë·ªß Ni√™n kh√≥a & H·ªçc k·ª≥");
      return;
    }
    if (!semesterStart || !semesterEnd) {
      setSemesterMessage("‚ùå Vui l√≤ng nh·∫≠p ng√†y b·∫Øt ƒë·∫ßu/k·∫øt th√∫c");
      return;
    }

    const payload: SetHocKyHienTaiRequest = {
      id_nien_khoa: selectedNienKhoa,
      id_hoc_ky: selectedHocKyId,
      ngay_bat_dau: semesterStart,
      ngay_ket_thuc: semesterEnd,
    };

    const result = await setHocKyHienTai(payload);

    if (result.isSuccess) {
      setSemesterMessage("‚úÖ Thi·∫øt l·∫≠p h·ªçc k·ª≥ hi·ªán t·∫°i th√†nh c√¥ng");

      const nienKhoa = hocKyNienKhoas.find((nk) => nk.id === selectedNienKhoa);
      const hocKy = nienKhoa?.hocKy.find((hk) => hk.id === selectedHocKyId);

      setCurrentSemester({
        ten_hoc_ky: hocKy?.tenHocKy,
        ten_nien_khoa: nienKhoa?.tenNienKhoa,
        ngay_bat_dau: semesterStart,
        ngay_ket_thuc: semesterEnd,
      });
    } else {
      setSemesterMessage(result.message || "‚ùå Kh√¥ng th·ªÉ thi·∫øt l·∫≠p h·ªçc k·ª≥");
    }
  };

  // ‚úÖ Handle phase time change
  const handlePhaseTimeChange = (
    phase: string,
    field: "start" | "end",
    value: string
  ) => {
    setPhaseTimes((prev) => ({
      ...prev,
      [phase]: { ...prev[phase], [field]: value },
    }));
  };

  const handleSubmitPhases = async (e: FormEvent) => {
    console.log("üî•üî•üî• handleSubmitPhases CALLED!");
    console.log("üì¶ Event:", e);

    e.preventDefault();

    console.log("üì¶ State before submit:");
    console.log("  - selectedHocKyId:", selectedHocKyId);
    console.log("  - phaseTimes:", phaseTimes);
    console.log("  - semesterStart:", semesterStart);
    console.log("  - semesterEnd:", semesterEnd);

    setMessage("");

    if (!selectedHocKyId) {
      console.log("‚ùå No hocKyId - returning early");
      setMessage("‚ùå Vui l√≤ng ch·ªçn h·ªçc k·ª≥ tr∆∞·ªõc");
      return;
    }

    // ‚úÖ Validate semester dates
    if (!semesterStart || !semesterEnd) {
      console.log("‚ùå Missing semester dates");
      setMessage("‚ùå Vui l√≤ng thi·∫øt l·∫≠p ng√†y b·∫Øt ƒë·∫ßu/k·∫øt th√∫c h·ªçc k·ª≥ tr∆∞·ªõc");
      return;
    }

    // Check if all phases have times
    const emptyPhases = PHASE_ORDER.filter(
      (phase) => !phaseTimes[phase]?.start || !phaseTimes[phase]?.end
    );

    if (emptyPhases.length > 0) {
      console.log("‚ùå Empty phases found:", emptyPhases);
      setMessage("‚ùå Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß th·ªùi gian cho t·∫•t c·∫£ c√°c giai ƒëo·∫°n");
      return;
    }

    console.log("‚úÖ All validations passed, preparing phases...");

    const phases: PhaseItemDTO[] = PHASE_ORDER.map((phase) => ({
      phase,
      startAt: new Date(phaseTimes[phase].start).toISOString(),
      endAt: new Date(phaseTimes[phase].end).toISOString(),
    }));

    console.log("üì¶ Phases to submit:", JSON.stringify(phases, null, 2));
    console.log("üöÄ Calling createBulkKyPhase API...");

    try {
      const result = await createBulkKyPhase({
        hocKyId: selectedHocKyId,
        hocKyStartAt: semesterStart, // ‚úÖ Pass h·ªçc k·ª≥ start date
        hocKyEndAt: semesterEnd, // ‚úÖ Pass h·ªçc k·ª≥ end date
        phases,
      });

      console.log("üì¶ API Response:", result);

      if (result.isSuccess) {
        console.log("‚úÖ Success!");
        setMessage("‚úÖ C·∫≠p nh·∫≠t tr·∫°ng th√°i h·ªá th·ªëng th√†nh c√¥ng");
      } else {
        console.log("‚ùå Failed:", result.message);
        setMessage(result.message || "‚ùå Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t tr·∫°ng th√°i");
      }
    } catch (error: any) {
      console.error("üí• Exception caught:", error);
      setMessage(`‚ùå L·ªói: ${error.message}`);
    }
  };

  // ‚úÖ Submit ghi danh
  const handleSubmitGhiDanh = async (data: any) => {
    setSubmitting(true);
    try {
      const result = await updateDotGhiDanh(data);

      if (result.isSuccess) {
        setMessage((prev) =>
          prev
            ? `${prev}\n‚úÖ C·∫≠p nh·∫≠t ƒë·ª£t ghi danh th√†nh c√¥ng`
            : "‚úÖ C·∫≠p nh·∫≠t ƒë·ª£t ghi danh th√†nh c√¥ng"
        );
      } else {
        setMessage((prev) =>
          prev ? `${prev}\n‚ùå ${result.message}` : `‚ùå ${result.message}`
        );
      }
    } catch (error: any) {
      setMessage((prev) =>
        prev ? `${prev}\n‚ùå L·ªói: ${error.message}` : `‚ùå L·ªói: ${error.message}`
      );
    } finally {
      setSubmitting(false);
    }
  };

  // ‚úÖ Load ng√†y b·∫Øt ƒë·∫ßu/k·∫øt th√∫c t·ª´ h·ªçc k·ª≥ ƒë∆∞·ª£c ch·ªçn
  useEffect(() => {
    if (!selectedHocKyId) return;

    const nienKhoa = hocKyNienKhoas.find((nk) => nk.id === selectedNienKhoa);
    const hocKy = nienKhoa?.hocKy.find((hk) => hk.id === selectedHocKyId);

    console.log("üîç Found h·ªçc k·ª≥:", hocKy);

    if (hocKy) {
      // ‚úÖ Set semester dates from h·ªçc k·ª≥
      const startDate = hocKy.ngayBatDau
        ? new Date(hocKy.ngayBatDau).toISOString().split("T")[0]
        : "";
      const endDate = hocKy.ngayKetThuc
        ? new Date(hocKy.ngayKetThuc).toISOString().split("T")[0]
        : "";

      console.log("üìÖ Setting dates:", { startDate, endDate });

      setSemesterStart(startDate);
      setSemesterEnd(endDate);
    }
  }, [selectedHocKyId, selectedNienKhoa, hocKyNienKhoas]);

  // ‚úÖ New state for Khoa filter
  const [selectedKhoa, setSelectedKhoa] = useState<string>("all");

  // ‚úÖ Mock phase time data (TODO: fetch from API)
  const ghiDanhPhaseData = {
    label: "üìù Phase Ghi Danh",
    start: phaseTimes["ghi_danh"]?.start || "",
    end: phaseTimes["ghi_danh"]?.end || "",
    status: (currentPhase === "ghi_danh" ? "active" : "upcoming") as
      | "active"
      | "upcoming"
      | "ended",
  };

  const dangKyPhaseData = {
    label: "üìö Phase ƒêƒÉng K√Ω H·ªçc Ph·∫ßn",
    start: phaseTimes["dang_ky_hoc_phan"]?.start || "",
    end: phaseTimes["dang_ky_hoc_phan"]?.end || "",
    status: (currentPhase === "dang_ky_hoc_phan" ? "active" : "upcoming") as
      | "active"
      | "upcoming"
      | "ended",
  };

  const handleUpdatePhaseTime = (
    phaseType: "ghi_danh" | "dang_ky",
    start: string,
    end: string
  ) => {
    // TODO: Call API to update phase time
    console.log("Update phase time:", { phaseType, start, end });

    openNotify({
      message: `API ch·ªânh th·ªùi gian ${
        phaseType === "ghi_danh" ? "Ghi Danh" : "ƒêƒÉng K√Ω"
      } ƒëang ƒë∆∞·ª£c ph√°t tri·ªÉn`,
      type: "info",
    });

    // ‚úÖ Update local state for preview
    const phaseKey = phaseType === "ghi_danh" ? "ghi_danh" : "dang_ky_hoc_phan";
    setPhaseTimes((prev) => ({
      ...prev,
      [phaseKey]: { start, end },
    }));
  };

  return (
    <section className="main__body">
      <div className="body__title">
        <p className="body__title-text">TR·∫†NG TH√ÅI H·ªÜ TH·ªêNG</p>
      </div>

      <div className="body__inner">
        {/* Loading states */}
        {(loadingHienHanh || loadingPhases) && (
          <p style={{ textAlign: "center", padding: "20px" }}>
            ƒêang t·∫£i d·ªØ li·ªáu...
          </p>
        )}

        {/* ‚úÖ Component h·ªçc k·ª≥/ni√™n kh√≥a */}
        <HocKyNienKhoaShowSetup
          hocKyNienKhoas={hocKyNienKhoas}
          loadingHocKy={loadingHocKy}
          submitting={submittingHocKy}
          selectedNienKhoa={selectedNienKhoa}
          selectedHocKy={selectedHocKyId || ""}
          semesterStart={semesterStart}
          semesterEnd={semesterEnd}
          currentSemester={currentSemester}
          semesterMessage={semesterMessage}
          onChangeNienKhoa={handleChangeNienKhoa}
          onChangeHocKy={handleChangeHocKy}
          onChangeStart={setSemesterStart}
          onChangeEnd={setSemesterEnd}
          onSubmit={handleSubmitSemester}
        />

        {/* ‚úÖ Component phases */}
        <PhaseHocKyNienKhoaSetup
          phaseNames={PHASE_NAMES}
          phaseOrder={PHASE_ORDER}
          phaseTimes={phaseTimes}
          currentPhase={currentPhase}
          message={message}
          semesterStart={semesterStart}
          semesterEnd={semesterEnd}
          submitting={submittingPhase || ghiDanhLoading || submitting}
          selectedHocKyId={selectedHocKyId || ""}
          onPhaseTimeChange={handlePhaseTimeChange}
          onSubmit={handleSubmitPhases}
          onSubmitGhiDanh={handleSubmitGhiDanh}
        />
      </div>
    </section>
  );
}
